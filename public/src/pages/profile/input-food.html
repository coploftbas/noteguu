<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="input-food-img.html">

<dom-module id="input-food">
    <style is="custom-style">
      
      .addFood{
          padding:0 10px 10px 10px;
          @apply(--shadow-elevation-2dp);
          background-color:#FFF;
      }

    </style>
    <template>
        <input id="inputFile" type="file" id="input" on-change="_fileChanged" style="display:none">
        <div class="addFood shadow-elevation-3dp">
            <input-food-img img-name="[[imgId]]"></input-food-img>
            <paper-input label="{{menuLabel}}" value="{{menuVal}}"></paper-input>
            <template is="dom-repeat" items="[[list]]">
                [[_listChanged(item.name,index)]]
                <paper-input label="list" value="{{item.name}}"></paper-input>
            </template>
            <paper-icon-button icon="image:add-to-photos" on-tap="selectPicture" title="upload"></paper-icon-button><br>
            <template is="dom-if" if="[[hasInput]]">
                <paper-button raised style="margin:right;" on-tap="saveFood">ADD</paper-button>
            </template><br>
        </div><br>

    </template>
    <script>
        Polymer({
            is:'input-food',
            properties:{
                menuLabel:{
                    type:String
                },
                menuVal:{
                    type:String
                },
                list:{
                    type:Array,
                    value:[]
                },
                hasInput:{
                    type:Boolean
                }
            },
            observers:['_inputChanged(menuVal)'],
            _inputChanged:function(val){
                if(val!=""){
                    this.set('menuLabel','Menu name');
                    this.set('hasInput',true);
                    
                    if(this.list.length==0){
                        this.push('list',{name:''});
                    }
                }else{
                    if(this.list.length==1 && this.list[0].name==""){
                        this.splice('list',0,1);
                    }
                    this.set('menuLabel','My menu is...');
                    this.set('hasInput',false);
                }
            },
            _listChanged:function(val,index){
                if(val!="" && this.list.length==index+1){
                    this.push('list',{name:''});
                }else if(val=="" && this.list.length==index+2){
                    this.splice('list',index+1,1);
                }
            },
            saveFood:function(){
                this.fire('add',{data:{name:this.menuVal,list:this.list,img:this.imgId || ''}});
                this.set('menuVal','');
                this.set('list',[]);
                this.set('imgId','');
            },
            selectPicture:function(){
                this.$.inputFile.click();
            },
            _fileChanged:function(e){
                var file = e.target.files[0];
                var type = false;
                var guid = this.guid();
                console.log(file);

                if(file.type == "image/jpeg"){
                    type = 'jpg'
                }else if(file.type=="image/png"){
                    type = 'png'
                }

                if(type){
                    var storageRef = firebase.app('food').storage().ref();
                    var mountainsRef = storageRef.child(`images/${guid}.${type}`);
                    mountainsRef.put(file).then((snapshot)=>{
                        this.imgId = `${guid}.${type}`;
                    });
                }else{
                    console.log('type unknow.');
                }
            },
            guid:function() {
                function s4() {
                    return Math.floor((1 + Math.random()) * 0x10000)
                    .toString(16)
                    .substring(1);
                }
                return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
            }
        });
    </script>
</dom-module>